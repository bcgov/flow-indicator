---
topic: "water"
title: "Long-Term Trends in River Flows in B.C."
output: envreportutils.internal::print_ver
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<!--
Copyright 2024 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->
```
```{r setup, echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, results = 'hide'}

library(dplyr)
library(ggplot2)
library(grid)
library(RColorBrewer)
library(scales)
library(bcgroundwater)
library(envreportutils)
library(gridExtra)
library(xtable)
library(lubridate)
library(forcats)
library(here)
library(magick)
library(png)
library(cowplot)
library(here)
library(sf)
library(stringr)

knitr::opts_chunk$set(cache = FALSE)

theme_set(theme_classic() +
            theme(text = element_text(colour = "black"),
                  axis.line = element_blank(),
                  axis.ticks = element_blank(),
                  panel.grid.major = element_line(colour = "grey85", size = 0.5,
                                                linetype = 1),
                  panel.grid.minor = element_line(colour = "grey90", size = 0.5,
                                                linetype = 1),
                  panel.grid.major.x = element_blank(),
                  panel.spacing = unit(0.6, "lines"),
                  plot.title = element_text(vjust = 2, hjust = 0.5),
                  axis.title = element_text(vjust = 0.1),
                  legend.position = "bottom", legend.title = element_blank(),
                  legend.text = element_text(size = 12),
                  axis.text.x = element_blank(),
                  strip.background = element_blank()))

label.colour <- "black" 
colour.scale <- brewer.pal(3,"Blues")

updateDate <- "February 2024"

# Load datasets
annual_flow_dat = readRDS(here("app/www","annual_flow_dat.rds"))
stations_sf = st_read(here("app/www","stations.gpkg")) 
mk_results_tbl = readRDS("print_ver/out/mk_results_tbl.rds")
mk_results_monthly_tbl = readRDS("print_ver/out/mk_results_monthly_tbl.rds")

stations_sf_filtered = stations_sf %>%
  filter(keep == 1)

# summary table of number of stations in each category
summary_table_cat = mk_results_tbl %>%
  filter(STATION_NUMBER %in% stations_sf_filtered$STATION_NUMBER) %>%
    mutate(category = case_when(significant == 0.1 ~ "No significant trend",
                                     .default = magnitude_fixed)) %>%
  group_by(metric, Regime, category) %>%
  summarise(n = n())

summary_table_direction = summary_table_cat %>%
  mutate(direction = case_when(str_detect(category,"increase") | str_detect(category,"later")  ~ "positive",
                               str_detect(category, "decrease") | str_detect(category, "earlier") ~ "negative",
                               .default = "no change")) %>%
  group_by(metric, Regime,  direction) %>%
  summarise(n = sum(n))

#Subset Average
average_cat = summary_table_cat %>%
  filter(metric == "Average Annual Flow")

average_direction = summary_table_direction %>%
  filter(metric == "Average Annual Flow")

#Subset Peak Flow
peak_cat = summary_table_cat %>%
  filter(metric == "Peak Flow")

peak_direction = summary_table_direction %>%
  filter(metric == "Peak Flow")

#Subset Low Flow
Low_cat = summary_table_cat %>%
  filter(metric == "Low Summer Flow")

Low_direction = summary_table_direction %>%
  filter(metric == "Low Summer Flow")

#Subset Freshet
freshet_cat = summary_table_cat %>%
  filter(metric == "Date of Freshet*")

freshet_direction = summary_table_direction %>%
  filter(metric == "Date of Freshet*")

#Subset Freshet
low_date_cat = summary_table_cat %>%
  filter(metric == "Start of Low Flow Period")

low_date_direction = summary_table_direction %>%
  filter(metric == "Start of Low Flow Period")

# Results by regime
annual_regime = 

# Monthly results

# Subset median flow by month
summary_table_cat_monthly = mk_results_monthly_tbl %>%
  filter(STATION_NUMBER %in% stations_sf_filtered$STATION_NUMBER) %>%
    mutate(category = case_when(significant == 0.1 ~ "No significant trend",
                                     .default = magnitude_fixed)) %>%
  group_by(metric, Month, category) %>%
  summarise(n = n())

summary_table_direction_monthly = summary_table_cat_monthly %>%
  mutate(direction = case_when(str_detect(category,"increase") | str_detect(category,"later")  ~ "positive",
                               str_detect(category, "decrease") | str_detect(category, "earlier") ~ "negative",
                               .default = "no change")) %>%
  group_by(metric, Month, direction) %>%
  summarise(n = sum(n))

# Load figures
load(here("print_ver/out","figures.Rdata"))

# Load map png (perhaps change this to a nicer looking map?)
leaflet_map = image_read(here("print_ver/out/figs","static_leaflet.png"))
```

-   **Changes in the timing and volume of river flow can affect both natural ecosystems and human communities.** They can affect our ability to predict and manage seasonal water resources and flood
    risks, and may impact natural systems that rely on natural flow patterns.
    
-   **Low river flows in summer may reduce the amount of water available for agriculture, hydroelectric power generation, industry and communities.** Low river flows are also associated with declines in
    water quality and warmer water temperatures which can threaten the
    health of aquatic ecosystems. 
    
-   **Trends in the volume of river flow varied by metric and regime type**. While peak flow volume trends are relatively constant across the province, annual flows are trending higher for many snow-dominated rivers. Volume of summer low flows is trending to lower levels for a number of rivers, particularly those with rain-dominated and mixed flow regimes. 

-   **Freshet is occurring earlier.** Freshet is taking place earlier for a large number of rivers across the province. The effect on the start of low flow period is less pronounced, however this metric is trending earlier for several snow-dominated rivers.

-   **Shift in seasonal timing of flow events seen in monthly flow trends.** For all three volume metrics (average, summer low and peak flows), flow is shifting to higher levels during the winter and spring months (November - May) and declining sharply in the summer (July - September).

<!-- -   **Trends in timing and volume of river flow vary geographically.** Annual average flows increased in the south-west of the province, while there was a strong trend for lower river flows on Vancouver Island. Timing of freshet was consistently earlier across all regions apart from the North-East.  -->

\newpage
    
# River flows in British Columbia

The indicator measures several metrics representing river flow at `r nrow(stations_sf_filtered)` stations
(`r nrow(stations_sf)` when including upstream stations) across the
Province. These stations have been monitored for a minimum of `r min(stations_sf_filtered$N_years)` 
years and a maximum of `r max(stations_sf_filtered$N_years)` years between `r min(stations_sf_filtered$Min_Year)` and `r max(stations_sf_filtered$Max_Year)`.

## Types of flow regimes

The variation in flow volume and timing of specific flow events varies significantly based on the source of the rivers water. Although there are many additional types of regimes ^1^, this analysis separates river flow regimes into four categories:

- **Snow-Dominated - Early Peak**: Flows are primarily driven by snow melt in the spring and early summer, resulting in a spring freshet and lower volumes during the summer. 

- **Snow-Dominated - Late Peak**: Flows are also driven by snow melt, but due to higher latitude and elevations at the river source, snow melt occurs later in the year, resulting in later freshet and delayed summer low flows

- **Rain-Dominated**: Flows are driven by precipitation. In B.C. such rivers are found in the coastal and island regions. Such rivers usually are high during the winter months and low during the summer.

- **Mixed Regime**: Flows are driven by a combination of snow melt and precipitation, leading to 
presence of a freshet event as well as high river flows during the winter months.

# Description of river flow metrics

The metrics measured at each station can be broken down into two types:
change in the volume of river flow and change in the timing of key river
flow events.

##Volume metrics

## Average annual flow

Average annual flow (meters^3^/s) was calculated within each water year^2^ (October -
October). Daily flows were identified for each station and the mean flow volume was calculated for each year of available data.

## Peak annual flow

Volume of peak flow (m^3^/s) was calculated using water
year (October - October). Volume of peak flow was calculated using a
3-day rolling window, identifying the maximum flow measured at
each station for each year. 

## Low summer flow

Volume of low flows (m^3^/s) was calculated based on the low flow
year^3^ (April - April). Volume of low flow was estimated based on a
7-day rolling window across the summer (May - October), and the minimum
flow was identified for each year at each station. 

## Timing metrics

## Date of freshet

Freshet is defined as the flood of a river, often due to snow melt. For this reason, it is calculated differently based on the river regime. For this analysis, we define date of freshet as the date whereby 50% of river discharge for a specified period has taken place. Water year is used for snow-dominated - Early Peak rivers, while for late peak, calendar year is used. For mixed regimes, identification of freshet timing is done by calculating river discharge between March and September, ignoring rain-dominated winter months. For rain-dominated stations, freshet does not take place and therefore not calculated.

## Start of low flow period

Timing of the beginning of low summer flows was calculated based on the long-term Mean Annual Discharge (MAD). The first date when 50% of MAD was reached after peak flow was used as the
definition of the start date of the low flow period. Due to the difference in flow regimes, a lower threshold (20% MAD) was used for rain-dominated rivers.

\newpage

# River Stations

The below map displays all downstream river stations (`r nrow(stations_sf_filtered)` stations) - the colour of the symbol represents the rivers' flow regime. Black lines represent the boundaries of the 6 major river basins (from top-left: Northwest, Liard, Peace, Coastal, Fraser and Columbia). The grey lines outline the 23 sub-basins that contain at least one monitoring station.
```{r overview_map, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.align = 'left', fig.width = 28, fig.asp=0.75}
plot(leaflet_map)
```

# Trend Results

## Volume metrics

- Of the `r nrow(stations_sf_filtered)` stations monitored across
the Province, `r sum(average_direction$n[average_direction$direction == "positive"])`
stations identified increasing average annual flows, of which `r sum(average_cat$n[average_cat$category == "> 5% increase"])` stations were increasing by more than 5% per decade. In contrast, `r sum(average_direction$n[average_direction$direction == "negative"])` stations displayed decreasing average annual flows, while the remaining `r sum(average_direction$n[average_direction$direction == "no change"])` stations were either less than 1% a year or had non-significant trends.

-   Annual peak flows trends were almost evenly split between increasing
(`r sum(peak_direction$n[peak_direction$direction == "positive"])` stations)
and decreasing
(`r sum(peak_direction$n[peak_direction$direction == "negative"])` stations),
while the vast majority were found to have little significant change
(`r sum(peak_direction$n[peak_direction$direction == "no change"])`
stations).

-   Low summer flow volume has decreased significantly over time for a
substantial number of rivers.
`r sum(Low_direction$n[Low_direction$direction == "negative"])` stations had
decreasing summer flows, and of those,
`r sum(Low_cat$n[Low_cat$category == "> 5% decrease"])` were at a rate greater than
5% per decade.

```{r fig.width = 10, fig.height = 8, echo = FALSE}
mk_all
```
* Reduced number of stations included in Date of Freshet due to rain-dominated rivers not being included in the analysis

## Timing metrics

-   Freshet has been occurring gradually earlier for a large number
of locations.
`r sum(freshet_direction$n[freshet_direction$direction == "negative"])` stations have
been trending earlier, and
`r sum(freshet_cat$n[freshet_cat$category == "> 2 days earlier"])` stations are
occurring 2 days earlier per decade. No stations were
trending later, while
`r sum(freshet_direction$n[freshet_direction$direction == "no change"] + freshet_cat$n[freshet_cat$category == "< 1 days change"])` stations
displayed trends that were less than 1 days change or not significant.

-   The majority of locations did not show significant trends for the start date of the low flow period. Of those that 
did, more stations had low flows occurring earlier
(`r sum(low_date_direction$n[low_date_direction$direction == "negative"])` stations) than later (`r sum(low_date_direction$n[low_date_direction$direction == "positive"])` stations).

# Volume and Timing of Flow by River Regime

Trends for several indicators varied based on the type of river regime, with a clear distinction between rain and mixed regime rivers, and those dominated by snow melt runoff. 

# Volume metrics

Trends towards increasing flow are present in a number of snow-dominated rivers (`r average_direction$n[average_direction$direction == "positive" & average_direction$Regime == "Snow-Dominated - Late Peak"]` stations with late peak flows and `r average_direction$n[average_direction$direction == "positive" & average_direction$Regime == "Snow-Dominated - Early Peak"]` stations with regular peak flows), while rain-dominated rivers and rivers with mixed regimes had some declines in average annual flows.

There were no clear trends in volume of peak flows, however more than half of rain-dominated rivers in B.C. have experienced a 5% or greater decline in low summer flow volume (`r Low_cat$n[Low_cat$category == "> 5% decrease" & Low_cat$Regime == "Rain-Dominated"]` stations). 

```{r fig.width = 10, fig.height = 8, echo = FALSE}
volume_regime
```

# Timing metrics

```{r fig.width = 10, fig.height = 8, echo = FALSE}
timing_regime
```

Earlier freshet is taking place for a large number of rivers in all regimes, particularly in rivers with spring freshet (`r freshet_direction$n[freshet_direction$direction == "negative" & freshet_direction$Regime == "Snow-Dominated - Early Peak"]` stations). Earlier starts to the low flow period were also documented in snow-dominated rivers (`r low_date_direction$n[low_date_direction$direction == "negative" & low_date_direction$Regime == "Snow-Dominated - Late Peak"]` stations with late peak flows and `r low_date_direction$n[low_date_direction$direction == "negative" & low_date_direction$Regime == "Snow-Dominated - Early Peak"]` stations with regular peak flows)

# Changes in Flow Volume by Month

## Average monthly flows

```{r fig.width = 10, fig.height=8, echo = FALSE}
monthly_average_bar_plot
```

-   Changes in average river flow across years varies by month. Winter and
spring months (December - May) have seen a significant positive trend in
average flows for a large number of rivers. For example, January flow trends are increasing for `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Average" & summary_table_direction_monthly$Month == "Jan" & summary_table_direction_monthly$direction == "positive"]` stations, and over 5% per decade in April and May for `r summary_table_cat_monthly$n[summary_table_cat_monthly$metric == "Average" & summary_table_cat_monthly$Month == "Apr" & summary_table_cat_monthly$category == "> 5% increase"]` and `r summary_table_cat_monthly$n[summary_table_cat_monthly$metric == "Average" & summary_table_cat_monthly$Month == "May" & summary_table_cat_monthly$category == "> 5% increase"]` stations respectively.

## Monthly low flows

```{r fig.width = 10, fig.height=8, echo = FALSE}
monthly_low_flow_bar_plot
```

-   Similarly to annual average flows, monthly low flows present contrasting trends. January and April have seen higher low flows over the years for `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Low Flow" & summary_table_direction_monthly$Month == "Jan" & summary_table_direction_monthly$direction == "positive"]` and `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Low Flow" & summary_table_direction_monthly$Month == "Apr" & summary_table_direction_monthly$direction == "positive"]` stations respectively. Inversely, July and August have `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Low Flow" & summary_table_direction_monthly$Month == "Jul" & summary_table_direction_monthly$direction == "negative"]` and `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Low Flow" & summary_table_direction_monthly$Month == "Aug" & summary_table_direction_monthly$direction == "negative"]` stations with decreasing low flows, of which `r summary_table_cat_monthly$n[summary_table_cat_monthly$metric == "Average" & summary_table_cat_monthly$Month == "Jul" & summary_table_cat_monthly$category == "> 5% decrease"]` and `r summary_table_cat_monthly$n[summary_table_cat_monthly$metric == "Low Flow" & summary_table_cat_monthly$Month == "Aug" & summary_table_cat_monthly$category == "> 5% decrease"]` stations are decreasing at more than 5% per decade.

## Monthly peak flows

```{r fig.width = 10, fig.height=8, echo = FALSE}
monthly_peak_flow_bar_plot
```

-   Peak flow monthly trends are almost identical to low and mean annual flows, monthly Peak Flows varied by month. As with Peak Flows, January and April have seen higher Peak Flows over the years for `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Peak Flow" & summary_table_direction_monthly$Month == "Jan" & summary_table_direction_monthly$direction == "positive"]` and `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Peak Flow" & summary_table_direction_monthly$Month == "Apr" & summary_table_direction_monthly$direction == "positive"]` stations respectively. Inversely, July and August have `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Peak Flow" & summary_table_direction_monthly$Month == "Jul" & summary_table_direction_monthly$direction == "negative"]` and `r summary_table_direction_monthly$n[summary_table_direction_monthly$metric == "Peak Flow" & summary_table_direction_monthly$Month == "Aug" & summary_table_direction_monthly$direction == "negative"]` stations with decreasing peak flows, of which `r summary_table_cat_monthly$n[summary_table_cat_monthly$metric == "Average" & summary_table_cat_monthly$Month == "Jul" & summary_table_cat_monthly$category == "> 5% decrease"]` and `r summary_table_cat_monthly$n[summary_table_cat_monthly$metric == "Peak Flow" & summary_table_cat_monthly$Month == "Aug" & summary_table_cat_monthly$category == "> 5% decrease"]` stations are decreasing at more than 5% per decade.

\newpage

## Useful Links

## Data

The data sets are all sourced from the B.C. Data Catalogue, distributed
under the [Open Government Licence - British
Columbia](https://www2.gov.bc.ca/gov/content?id=A519A56BC2BF44E4A008B33FCF527F61).

-   [Indicator Summary Data: Long-term Trends in Timing and Volume of
    B.C.'s River
    Flow](https://catalogue.data.gov.bc.ca/dataset/indicator-summary-data-change-in-timing-and-volume-of-river-flow-in-bc-1912-2012-)

-   River Flow Stations and daily flow data accessed with ['tidyhydat'](https://cran.r-project.org/web/packages/tidyhydat/index.html) R
    Package

<!-- Here Jon needs to upload watershed and basin layers (or at least point in right direction) -->
<!-- -   [Hydrologic -->
<!--     Zones](https://catalogue.data.gov.bc.ca/dataset/bc-hydrologic-zones). -->

------------------------------------------------------------------------

Published and Available Online at Environmental Reporting BC
(`r updateDate`):
<https://www.env.gov.bc.ca/soe/indicators/climate-change/rivers.html0>

Email correspondence to:
[envreportbc\@gov.bc.ca](mailto:envreportbc@gov.bc.ca){.email}

*Suggested Citation*:\
Environmental Reporting BC. 2024. Long-Term Trends in River Flows in
B.C. State of Environment Reporting, Ministry of Environment and Climate
Change Strategy, British Columbia, Canada.

## Methods

### Regime designation

The seasonal distribution of high flows and lows flow vary greatly across the province due to high hydroclimate diversity driven by the amounts and timing of precipitation and/or snow-melt processes. As such, different indicators and their timing are required to appropriately represent hydrological changes at different stations. To assign appropriate indicators to each station, seasonal streamflow regimes were determined using a statistical clustering analysis based on normalized monthly flows for each station^1^. Clusters were then grouped into the four high-level seasonal regimes to assign appropriate indictors and their timing.

### Filtering procedure

To account for variation in monitoring at different stations on
different rivers, a set of filtering procedures were implemented to
reduce potential for erroneous trend estimations. These included:

-   **Missing annual data**: Station-years with more than 2% (~ 1 week) of data missing 
    were removed from the analysis.

-   **Data gaps**: Monitoring stations containing gaps of 5 or more
    years had all annual data preceding the gap removed, to maintain
    relatively continuous datasets at each station for trend analyses.

-   **Recently active**: Stations were required to be active as recently
    as 2019 for inclusion in the analysis.

-   **Minimum sample size**: Only stations with more than 10 years of
    monitoring data were retained.

-   **Regulated Rivers**: A river is defined as regulated if the flow
    regime has been modified and results in a 10% increase or decrease
    in flow (REF). For the purpose of this analysis, regulated stations
    were removed from the analysis (apart from certain instances where
    flow was deemed close to natural).

-   **Upstream stations**: A number of rivers include multiple
    monitoring stations. In such situations, only the downstream
    stations are included (although upstream locations can be inspected
    using the online app).

-   **Recently installed stations**: Stations that have been installed
    within the last 30 years were included within the analysis if they had at least 
    10 years of data (and can be toggled on/off within the online app).
    
### Trend Analysis

TBC

### References

- ^1^ Curran, J. H., & Biles, F. E. (2021). Identification of seasonal streamflow regimes and streamflow drivers for daily and peak flows in Alaska. Water Resources Research, 57. https://doi.org/10.1029/2020wr028425

-   ^2^[Description of Water Year (USGS)](https://water.usgs.gov/nwc/explain_data.html)

-   ^3^[Description of Low Flow Year (EPA)](https://www.epa.gov/hydrowq/definition-and-characteristics-low-flows)

\newpage

## Appendix 1

### Changes in Volume and Timing by Watersheds

### Flow volume

### Average annual flow

```{r echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, results = 'hide'}
average_by_zone_cat = mk_results_tbl %>%
  filter(metric == "Average Annual Flow") %>%
   filter(STATION_NUMBER %in% stations_sf_filtered$STATION_NUMBER) %>%
    mutate(category = case_when(significant == 0.1 ~ "No significant trend",
                                     .default = magnitude_fixed)) %>%
  group_by(Sub_Basin, category) %>%
  summarise(n = n())

average_by_zone_direction = average_by_zone_cat %>%
  mutate(direction = case_when(str_detect(category,"increase") | str_detect(category,"later")  ~ "positive",
                               str_detect(category, "decrease") | str_detect(category, "earlier") ~ "negative",
                               .default = "no change")) %>%
  group_by(Sub_Basin, direction) %>%
  summarise(n = sum(n))
```


```{r fig.width = 10, fig.height=8, echo = FALSE}
annual_bar_plot
```

-   For average annual flow, the vast majority of stations had non-significant trends. In the south-central and -west hydrologic zones, a number of stations had increasing annual flow trends including the Fraser Plateau (`r average_by_zone_direction$n[average_by_zone_direction$Sub_Basin == "Fraser Plateau" & average_by_zone_direction$direction == "positive"]` of `r sum(average_by_zone_direction$n[average_by_zone_direction$Sub_Basin == "Fraser Plateau"])` stations) and the west and central South Coast Mountains (`r average_by_zone_direction$n[average_by_zone_direction$Sub_Basin == "Western South Coast Mountains" & average_by_zone_direction$direction == "positive"]` of `r sum(average_by_zone_direction$n[average_by_zone_direction$Sub_Basin == "Western South Coast Mountains"])` and `r average_by_zone_direction$n[average_by_zone_direction$Sub_Basin == "Central South Coast Mountains" & average_by_zone_direction$direction == "positive"]` of `r sum(average_by_zone_direction$n[average_by_zone_direction$Sub_Basin == "Central South Coast Mountains"])` stations respectively).

## Peak flow

```{r echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, results = 'hide'}
peak_by_zone_cat = mk_results_tbl %>%
  filter(metric == "Peak Flow") %>%
   filter(STATION_NUMBER %in% stations_sf_filtered$STATION_NUMBER) %>%
    mutate(category = case_when(significant == 0.1 ~ "No significant trend",
                                     .default = magnitude_fixed)) %>%
  group_by(Sub_Basin, category) %>%
  summarise(n = n())

peak_by_zone_direction = peak_by_zone_cat %>%
  mutate(direction = case_when(str_detect(category,"increase") | str_detect(category,"later")  ~ "positive",
                               str_detect(category, "decrease") | str_detect(category, "earlier") ~ "negative",
                               .default = "no change")) %>%
  group_by(Sub_Basin, direction) %>%
  summarise(n = sum(n))
```


```{r fig.width = 10, fig.height=8, echo = FALSE}
peak_bar_plot
```

-   There were no clear geographic patterns in trends in peak flow. The only result to highlight is Western Vancouver Island, which has `r peak_by_zone_direction$n[peak_by_zone_direction$Sub_Basin == "Western Vancouver Island" & peak_by_zone_direction$direction == "positive"]` of `r sum(peak_by_zone_direction$n[peak_by_zone_direction$Sub_Basin == "Western Vancouver Island"])` stations with increasing and `r peak_by_zone_direction$n[peak_by_zone_direction$Sub_Basin == "Western Vancouver Island" & peak_by_zone_direction$direction == "negative"]` of `r sum(peak_by_zone_direction$n[peak_by_zone_direction$Sub_Basin == "Western Vancouver Island"])` stations with decreasing annual peak flows.

## Low flow
```{r echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, results = 'hide'}
low_by_zone_cat = mk_results_tbl %>%
  filter(metric == "Low Summer Flow") %>%
   filter(STATION_NUMBER %in% stations_sf_filtered$STATION_NUMBER) %>%
    mutate(category = case_when(significant == 0.1 ~ "No significant trend",
                                     .default = magnitude_fixed)) %>%
  group_by(Sub_Basin, category) %>%
  summarise(n = n())

low_by_zone_direction = low_by_zone_cat %>%
  mutate(direction = case_when(str_detect(category,"increase") | str_detect(category,"later")  ~ "positive",
                               str_detect(category, "decrease") | str_detect(category, "earlier") ~ "negative",
                               .default = "no change")) %>%
  group_by(Sub_Basin, direction) %>%
  summarise(n = sum(n))
```


```{r fig.width = 10, fig.height=8, echo = FALSE}
low_bar_plot
```

-   Trends is summer low flow are most apparent on Vancouver Island. Western Vancouver Islands monitored rivers are almost all (`r low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Western Vancouver Island" & low_by_zone_direction$direction == "negative"]` of `r sum(low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Western Vancouver Island"])` stations) are decreasing at more than 5% volume per decade. Eastern Vancouver Island also has a large proportion of river low flows in decline (`r low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Eastern Vancouver Island" & low_by_zone_direction$direction == "negative"]` of `r sum(low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Eastern Vancouver Island"])` stations). Other hydrologic zones with decreasing summer low flow volumes to highlight include the Western South and Central Coast Mountains (`r low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Western South Coast Mountains" & low_by_zone_direction$direction == "negative"]` of `r sum(low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Western South Coast Mountains"])` and `r low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Central Coast Mountains" & low_by_zone_direction$direction == "negative"]` of `r sum(low_by_zone_direction$n[low_by_zone_direction$Sub_Basin == "Central Coast Mountains"])` stations respectively)

# Flow timing

## Date of freshet

```{r echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, results = 'hide'}
freshet_by_zone_cat = mk_results_tbl %>%
  filter(metric == "Date of Freshet") %>%
   filter(STATION_NUMBER %in% stations_sf_filtered$STATION_NUMBER) %>%
    mutate(category = case_when(significant == 0.1 ~ "No significant trend",
                                     .default = magnitude_fixed)) %>%
  group_by(Sub_Basin, category) %>%
  summarise(n = n())

freshet_by_zone_direction = freshet_by_zone_cat %>%
  mutate(direction = case_when(str_detect(category,"increase") | str_detect(category,"later")  ~ "positive",
                               str_detect(category, "decrease") | str_detect(category, "earlier") ~ "negative",
                               .default = "no change")) %>%
  group_by(Sub_Basin, direction) %>%
  summarise(n = sum(n))
```

```{r fig.width = 10, fig.height=8, echo = FALSE}
freshet_bar_plot
```

-   Timing of freshet has been getting earlier for stations across most hydrologic zones. North-eastern B.C. was the only region that was immune to this effect, apart from the Rocky Mountains which saw earlier freshet at several stations (`r freshet_by_zone_direction$n[freshet_by_zone_direction$Sub_Basin == "Northern Rocky Mountains" & freshet_by_zone_direction$direction == "negative"]` of `r sum(freshet_by_zone_direction$n[freshet_by_zone_direction$Sub_Basin == "Northern Rocky Mountains"])` stations). This pattern was also missing from Vancouver Island, although this is likely due to the majority of rivers not being snow and glacier-fed - the driver behind the freshet phenomena. 

## Start of low flow period
```{r echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, results = 'hide'}
date_low_by_zone_cat = mk_results_tbl %>%
  filter(metric == "Date of Low Summer Flow") %>%
   filter(STATION_NUMBER %in% stations_sf_filtered$STATION_NUMBER) %>%
    mutate(category = case_when(significant == 0.1 ~ "No significant trend",
                                     .default = magnitude_fixed)) %>%
  group_by(Sub_Basin, category) %>%
  summarise(n = n())

date_low_by_zone_direction = date_low_by_zone_cat %>%
  mutate(direction = case_when(str_detect(category,"increase") | str_detect(category,"later")  ~ "positive",
                               str_detect(category, "decrease") | str_detect(category, "earlier") ~ "negative",
                               .default = "no change")) %>%
  group_by(Sub_Basin, direction) %>%
  summarise(n = sum(n))
```

```{r fig.width = 10, fig.height=8, echo = FALSE}
date_low_bar_plot
```

Trends in the timing of the start of low flow period are far less clear than that of timing of freshet. Trends indicating earlier timing of low flows were present in some hydrologic zones, most prominent in the Southern Quesnel Highland (`r date_low_by_zone_direction$n[date_low_by_zone_direction$Sub_Basin == "Southern Quesnel Highland" & date_low_by_zone_direction$direction == "negative"]` of `r sum(date_low_by_zone_direction$n[date_low_by_zone_direction$Sub_Basin == "Southern Quesnel Highland"])` stations), the Fraser Plateau (`r date_low_by_zone_direction$n[date_low_by_zone_direction$Sub_Basin == "Fraser Plateau" & date_low_by_zone_direction$direction == "negative"]` of `r sum(date_low_by_zone_direction$n[date_low_by_zone_direction$Sub_Basin == "Fraser Plateau"])` stations) and Nechako Plateau (`r date_low_by_zone_direction$n[date_low_by_zone_direction$Sub_Basin == "Nechako Plateau" & date_low_by_zone_direction$direction == "negative"]` of `r sum(date_low_by_zone_direction$n[date_low_by_zone_direction$Sub_Basin == "Nechako Plateau"])` stations).


## Appendix 2

```{r station_plots, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results = 'asis', fig.height = 7.5, dev = "pdf"}

# individual well plots
# load('../groundwater-levels-indicator/tmp/well_plots.RData')

knitr_latex_char <- function(x) {
  y <- gsub("\\\\", "\\\\textbackslash{}", x) # backslash has to be first!
  y <- gsub("([#$%&_])", "\\\\\\1", y) # Doesn't deal with { or } because of function{}
  y <- gsub("\\^", "\\\\textasciicircum{}", y)
  y <- gsub("~", "\\\\textasciitilde{}", y)
  return(y)
}

# theme_set(base_theme)

  for (station in stations_sf_filtered$STATION_NUMBER) {
    
    stationname <- stations_sf_filtered %>%
      filter(STATION_NUMBER == station) %>%
      pull(STATION_NAME)
    
    regimetype = stations_sf_filtered %>%
      filter(STATION_NUMBER == station) %>%
      pull(Regime)
    
    reg = stations_sf_filtered %>%
      filter(STATION_NUMBER == station) %>%
      pull(Sub_Basin)
    
    cat(paste0('\\subsubsection*{',reg,": ",
               knitr_latex_char(stationname),
               '}'))
    
    cat(paste0('\\subsubsection*{',"Regime Type: ",
               knitr_latex_char(regimetype),
               '}'))

    mapplot <- readPNG(paste0("print_ver/out/figs/maps/",stationname,".png"))
    mapplot = ggdraw() +
      draw_image(mapplot)
    
    hydroplot = readPNG(paste0("print_ver/out/figs/hgraphs/",station,".png"))  
    hydroplot = ggdraw() +
      draw_image(hydroplot)
    
    volumeplot = readPNG(paste0("print_ver/out/figs/volume_plots/",station,".png"))  
    volumeplot = ggdraw() +
      draw_image(volumeplot)
    
    timingplot = readPNG(paste0("print_ver/out/figs/timing_plots/",station,".png"))  
    timingplot = ggdraw() +
      draw_image(timingplot)    
    
    grid.arrange(mapplot+ theme(plot.margin = unit(c(-1,0.5,-1,0.01),"cm")),
                 hydroplot+ theme(plot.margin = unit(c(-1,0.01,-1,0.01),"cm")),
                 volumeplot + theme(plot.margin = unit(c(0.5,0.5,-1,0.01),"cm")),
                 timingplot + theme(plot.margin = unit(c(0.5,0.5,0,0.01),"cm")),
                 ncol = 2)
    # 
    cat('\\newpage ')
  }
```
